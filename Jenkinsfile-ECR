@Library('jenkins_shared_lib_java_app') _
pipeline{

    agent any
    tools {
        maven 'maven-latest'
        jdk 'jdk17'
    }

    parameters {
    choice(name: 'action', choices: ['create', 'delete'], description: 'Choose action')
    string(name: 'aws_account_id', description: "account id of aws", defaultValue: '365458640688')
    string(name: 'region', description: "Region of image ", defaultValue: 'ap-south-1')
    string(name: 'ecrRepoName', description: "aws Repo name", defaultValue: 'jenkins_shared_lib_java_app')
}


    
    stages{
        stage('Clean Workspace') {
            when { expression { params.action == 'create' } }
            steps {
                echo "ðŸ§¹ Cleaning workspace before checkout..."
                cleanWs()  // Jenkins built-in step from Workspace Cleanup Plugin
            }
        }
        
        stage("Git Checkout"){
            when { expression { params.action == 'create' } }
            steps{
                script{
                    gitCheckout(
                        branch: "main" ,
                        url: "https://github.com/nrjydv1997/devops_shared_lib_java_app.git"
                         
                        )
                }
            }
        }

        stage('MVN Test'){
            when { expression { params.action == 'create' } }
            steps{
                script{
                    mvnTest()
                }
            }
        }

        stage('MVN IntegrationTest'){
            when { expression { params.action == 'create' } }
            steps{
                script{
                    mvnIntegrationTest()
                }
            }
        }

        stage('Sonar StaticCodeAnalysis'){
            when { expression { params.action == 'create' } }
            steps{
                script{
                    def SonarQubeCredentialsId = 'sonar-api'
                    staticCodeAnalysis(SonarQubeCredentialsId)
                }
            }
        }

        stage('Quality Gate Status check'){
            when { expression { params.action == 'create' } }
            steps{
                script{
                    def SonarQubeCredentialsId = 'sonar-api'
                    qualityGateStatus(SonarQubeCredentialsId)
                }
            }
        }

        stage('MVN Build'){
            when { expression { params.action == 'create' } }
            steps{
                script{
                    mvnBuild()
                }
            }
        }

        stage('Docker Image Build : ECR'){
            when { expression { params.action == 'create' } }
            steps{
                dockerBuildEcr("${params.aws_account_id}","${params.region}","${params.ecrRepoName}")
            }
        }

        stage("Docker Image Scan"){
            when { expression { params.action == 'create' } }
            steps{
                script{
                    dockerImageScanEcr("${params.aws_account_id}","${params.region}","${params.ecrRepoName}")
                }
            }
        }

        stage("Docker Image Push ecr"){
            when { expression { params.action == 'create' } }
            steps{
                script{
                    dockerImagePushEcr("${params.aws_account_id}","${params.region}","${params.ecrRepoName}")
                }
            }
        }

        stage("Docker Image Cleanup"){
            when { expression { params.action == 'create' } }
            steps{
                script{
                    dockerImageCleanup("${params.aws_account_id}","${params.region}","${params.ecrRepoName}")
                }
            }
        }
    }
}
